// Enhanced Assignment Submission Service with File Upload Integration\nimport { apiClient, ApiErrorHandler } from '@/services/api/base.service';\nimport FileUploadService, { UploadedFile } from '@/services/file-upload.service';\n\nexport interface AssignmentSubmissionData {\n  content?: string;\n  files?: File[] | UploadedFile[];\n  external_url?: string;\n}\n\nexport interface ProjectSubmissionData {\n  text_content?: string;\n  files?: File[] | UploadedFile[];\n  team_members?: number[];\n}\n\nexport interface SubmissionResponse {\n  success: boolean;\n  message: string;\n  submission: {\n    id: number;\n    assignment_id?: number;\n    project_id?: number;\n    submitted_at: string;\n    files_count: number;\n    has_text: boolean;\n    status: string;\n    team_size?: number;\n  };\n}\n\nexport interface AssignmentWithStatus {\n  id: number;\n  title: string;\n  description: string;\n  assignment_type: 'file_upload' | 'text_response' | 'both';\n  max_file_size_mb: number;\n  allowed_file_types?: string;\n  due_date?: string;\n  points_possible: number;\n  course: {\n    id: number;\n    title: string;\n  };\n  module?: {\n    id: number;\n    title: string;\n  };\n  lesson?: {\n    id: number;\n    title: string;\n  };\n  submission_status: {\n    submitted: boolean;\n    submission_id?: number;\n    grade?: number;\n    feedback?: string;\n    submitted_at?: string;\n    graded_at?: string;\n    files_count?: number;\n    has_text_content?: boolean;\n  };\n}\n\nexport interface ProjectWithStatus {\n  id: number;\n  title: string;\n  description: string;\n  objectives?: string;\n  submission_format: 'file_upload' | 'text_response' | 'both' | 'presentation';\n  max_file_size_mb: number;\n  allowed_file_types?: string;\n  due_date: string;\n  points_possible: number;\n  collaboration_allowed: boolean;\n  max_team_size: number;\n  course: {\n    id: number;\n    title: string;\n  };\n  modules: Array<{\n    id: number;\n    title: string;\n  }>;\n  submission_status: {\n    submitted: boolean;\n    submission_id?: number;\n    grade?: number;\n    feedback?: string;\n    submitted_at?: string;\n    graded_at?: string;\n    team_members?: string[];\n    files_count?: number;\n    has_text_content?: boolean;\n  };\n}\n\nexport interface SubmissionDetail {\n  assignment?: AssignmentWithStatus;\n  project?: ProjectWithStatus;\n  submission: {\n    id: number;\n    content?: string;\n    text_content?: string;\n    files: Array<{\n      url: string;\n      filename: string;\n      size: number;\n      contentType: string;\n      uploadedAt: string;\n    }>;\n    external_url?: string;\n    submitted_at: string;\n    grade?: number;\n    feedback?: string;\n    graded_at?: string;\n    graded_by?: {\n      id: number;\n      name: string;\n    };\n    team_members?: Array<{\n      id: number;\n      name: string;\n    }>;\n  };\n}\n\nexport class EnhancedSubmissionService {\n  private static readonly BASE_PATH = '/uploads';\n  private static readonly STUDENT_PATH = '/student';\n\n  /**\n   * Get all assignments for enrolled courses with submission status\n   */\n  static async getAssignments(): Promise<AssignmentWithStatus[]> {\n    try {\n      const response = await apiClient.get(`${this.STUDENT_PATH}/assignments`);\n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Get assignment details with submission status\n   */\n  static async getAssignmentDetails(assignmentId: number): Promise<SubmissionDetail> {\n    try {\n      const response = await apiClient.get(`${this.STUDENT_PATH}/assignments/${assignmentId}`);\n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Submit an assignment with file upload support\n   */\n  static async submitAssignment(\n    assignmentId: number,\n    data: AssignmentSubmissionData,\n    options?: {\n      onFileProgress?: (fileIndex: number, progress: number) => void;\n      onOverallProgress?: (completed: number, total: number) => void;\n    }\n  ): Promise<SubmissionResponse> {\n    try {\n      let uploadedFiles: UploadedFile[] = [];\n      \n      // Upload files if they are File objects\n      if (data.files && data.files.length > 0) {\n        const filesToUpload = data.files.filter((file): file is File => file instanceof File);\n        const alreadyUploaded = data.files.filter((file): file is UploadedFile => !(file instanceof File));\n        \n        if (filesToUpload.length > 0) {\n          uploadedFiles = await FileUploadService.uploadFiles(filesToUpload, {\n            folder: 'assignments',\n            assignmentId,\n            onFileProgress: options?.onFileProgress,\n            onOverallProgress: options?.onOverallProgress\n          });\n        }\n        \n        uploadedFiles = [...uploadedFiles, ...alreadyUploaded];\n      }\n      \n      // Prepare file metadata\n      const filesMetadata = uploadedFiles.map(file => ({\n        url: file.url,\n        filename: (file as any).originalName || file.pathname.split('/').pop() || 'file',\n        size: file.size,\n        contentType: file.contentType,\n        uploadedAt: file.uploadedAt\n      }));\n      \n      // Submit to backend\n      const response = await apiClient.post(\n        `${this.BASE_PATH}/assignments/${assignmentId}/submit-with-files`,\n        {\n          content: data.content,\n          files: filesMetadata,\n          external_url: data.external_url\n        }\n      );\n      \n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Get all projects for enrolled courses with submission status\n   */\n  static async getProjects(): Promise<ProjectWithStatus[]> {\n    try {\n      const response = await apiClient.get(`${this.STUDENT_PATH}/projects`);\n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Get project details with submission status\n   */\n  static async getProjectDetails(projectId: number): Promise<SubmissionDetail> {\n    try {\n      const response = await apiClient.get(`${this.STUDENT_PATH}/projects/${projectId}`);\n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Submit a project with file upload support\n   */\n  static async submitProject(\n    projectId: number,\n    data: ProjectSubmissionData,\n    options?: {\n      onFileProgress?: (fileIndex: number, progress: number) => void;\n      onOverallProgress?: (completed: number, total: number) => void;\n    }\n  ): Promise<SubmissionResponse> {\n    try {\n      let uploadedFiles: UploadedFile[] = [];\n      \n      // Upload files if they are File objects\n      if (data.files && data.files.length > 0) {\n        const filesToUpload = data.files.filter((file): file is File => file instanceof File);\n        const alreadyUploaded = data.files.filter((file): file is UploadedFile => !(file instanceof File));\n        \n        if (filesToUpload.length > 0) {\n          uploadedFiles = await FileUploadService.uploadFiles(filesToUpload, {\n            folder: 'projects',\n            assignmentId: projectId, // Reuse the same field for projectId\n            onFileProgress: options?.onFileProgress,\n            onOverallProgress: options?.onOverallProgress\n          });\n        }\n        \n        uploadedFiles = [...uploadedFiles, ...alreadyUploaded];\n      }\n      \n      // Prepare file metadata\n      const filesMetadata = uploadedFiles.map(file => ({\n        url: file.url,\n        filename: (file as any).originalName || file.pathname.split('/').pop() || 'file',\n        size: file.size,\n        contentType: file.contentType,\n        uploadedAt: file.uploadedAt\n      }));\n      \n      // Submit to backend\n      const response = await apiClient.post(\n        `${this.BASE_PATH}/projects/${projectId}/submit-with-files`,\n        {\n          text_content: data.text_content,\n          files: filesMetadata,\n          team_members: data.team_members || []\n        }\n      );\n      \n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Get files for an assignment submission\n   */\n  static async getAssignmentFiles(\n    assignmentId: number,\n    submissionId?: number\n  ): Promise<{\n    files: Array<{\n      url: string;\n      filename: string;\n      size: number;\n      contentType: string;\n      uploadedAt: string;\n    }>;\n    submission_id?: number;\n    submitted_at?: string;\n  }> {\n    try {\n      const params = new URLSearchParams();\n      if (submissionId) {\n        params.append('submission_id', submissionId.toString());\n      }\n      \n      const response = await apiClient.get(\n        `${this.BASE_PATH}/assignments/${assignmentId}/files?${params}`\n      );\n      \n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Get files for a project submission\n   */\n  static async getProjectFiles(\n    projectId: number,\n    submissionId?: number\n  ): Promise<{\n    files: Array<{\n      url: string;\n      filename: string;\n      size: number;\n      contentType: string;\n      uploadedAt: string;\n    }>;\n    submission_id?: number;\n    submitted_at?: string;\n  }> {\n    try {\n      const params = new URLSearchParams();\n      if (submissionId) {\n        params.append('submission_id', submissionId.toString());\n      }\n      \n      const response = await apiClient.get(\n        `${this.BASE_PATH}/projects/${projectId}/files?${params}`\n      );\n      \n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Validate file before upload\n   */\n  static async validateFile(file: {\n    filename: string;\n    size: number;\n    type: string;\n  }): Promise<{\n    valid: boolean;\n    errors: string[];\n    max_size_mb: number;\n    allowed_types: string[];\n  }> {\n    try {\n      const response = await apiClient.post(\n        `${this.BASE_PATH}/validate-file`,\n        file\n      );\n      \n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Get file information\n   */\n  static async getFileInfo(url: string): Promise<{\n    file_info: {\n      url: string;\n      accessible: boolean;\n      last_checked: string;\n    };\n  }> {\n    try {\n      const response = await apiClient.post(\n        `${this.BASE_PATH}/file-info`,\n        { url }\n      );\n      \n      return response.data;\n    } catch (error) {\n      throw ApiErrorHandler.handleError(error);\n    }\n  }\n\n  /**\n   * Download multiple files as a ZIP archive\n   */\n  static async downloadFilesAsZip(\n    files: Array<{\n      url: string;\n      filename: string;\n    }>,\n    zipName: string = 'submission-files.zip'\n  ): Promise<void> {\n    try {\n      // Create a simple ZIP download by opening each file\n      // In a production environment, you might want to implement server-side ZIP creation\n      for (let i = 0; i < files.length; i++) {\n        const file = files[i];\n        const link = document.createElement('a');\n        link.href = FileUploadService.getDownloadUrl(file.url, file.filename);\n        link.download = file.filename;\n        link.target = '_blank';\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        \n        // Add delay between downloads to prevent browser blocking\n        if (i < files.length - 1) {\n          await new Promise(resolve => setTimeout(resolve, 200));\n        }\n      }\n    } catch (error: any) {\n      console.error('Download error:', error);\n      throw new Error('Failed to download files');\n    }\n  }\n\n  /**\n   * Check submission requirements\n   */\n  static checkSubmissionRequirements(\n    assignment: AssignmentWithStatus | ProjectWithStatus,\n    submission: {\n      textContent?: string;\n      files?: (File | UploadedFile)[];\n    }\n  ): {\n    valid: boolean;\n    errors: string[];\n    warnings: string[];\n  } {\n    const errors: string[] = [];\n    const warnings: string[] = [];\n    \n    const submissionFormat = (assignment as any).assignment_type || (assignment as any).submission_format;\n    const hasText = Boolean(submission.textContent?.trim());\n    const hasFiles = Boolean(submission.files?.length);\n    \n    // Check text requirements\n    if ((submissionFormat === 'text_response' && !hasText) || \n        (submissionFormat === 'both' && !hasText && !hasFiles)) {\n      errors.push('Text response is required');\n    }\n    \n    // Check file requirements\n    if ((submissionFormat === 'file_upload' && !hasFiles) || \n        (submissionFormat === 'both' && !hasFiles && !hasText)) {\n      errors.push('File upload is required');\n    }\n    \n    // Check file sizes and types\n    if (submission.files && submission.files.length > 0) {\n      const maxSizeBytes = (assignment.max_file_size_mb || 50) * 1024 * 1024;\n      const allowedTypes = assignment.allowed_file_types?.split(',').map(t => t.trim()) || ['*'];\n      \n      for (const file of submission.files) {\n        const fileSize = file instanceof File ? file.size : (file as UploadedFile).size;\n        const fileName = file instanceof File ? file.name : \n          ((file as any).originalName || (file as UploadedFile).pathname.split('/').pop() || 'file');\n        \n        if (fileSize > maxSizeBytes) {\n          errors.push(`File \"${fileName}\" exceeds maximum size of ${assignment.max_file_size_mb || 50}MB`);\n        }\n        \n        if (!allowedTypes.includes('*')) {\n          const fileExt = '.' + fileName.split('.').pop()?.toLowerCase();\n          if (!allowedTypes.some(type => type.toLowerCase() === fileExt)) {\n            errors.push(`File \"${fileName}\" has an unsupported file type. Allowed: ${allowedTypes.join(', ')}`);\n          }\n        }\n      }\n      \n      // Check total file count\n      if (submission.files.length > 10) {\n        warnings.push('You are uploading more than 10 files. This might slow down the submission process.');\n      }\n    }\n    \n    // Check due date\n    if (assignment.due_date) {\n      const dueDate = new Date(assignment.due_date);\n      const now = new Date();\n      \n      if (now > dueDate) {\n        errors.push('Assignment is overdue');\n      } else if (now.getTime() + (24 * 60 * 60 * 1000) > dueDate.getTime()) {\n        warnings.push('Assignment is due within 24 hours');\n      }\n    }\n    \n    return {\n      valid: errors.length === 0,\n      errors,\n      warnings\n    };\n  }\n}\n\nexport default EnhancedSubmissionService;