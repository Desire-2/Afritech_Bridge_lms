import React, { useState, useEffect } from 'react';\nimport { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Badge } from '@/components/ui/badge';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';\nimport { \n  TrendingUp, \n  Clock, \n  Users, \n  FileText, \n  AlertTriangle, \n  CheckCircle, \n  BarChart3,\n  Send,\n  RefreshCw\n} from 'lucide-react';\n\ninterface ModificationStats {\n  total_assignments: number;\n  assignments_with_modifications: number;\n  total_modification_requests: number;\n  pending_resubmissions: number;\n  completed_resubmissions: number;\n  average_resubmissions_per_assignment: number;\n  modification_rate: number;\n}\n\ninterface ModificationRequest {\n  id: number;\n  title: string;\n  course_title: string;\n  lesson_title: string;\n  student_name: string;\n  student_email: string;\n  modification_reason: string;\n  requested_at: string;\n  needs_resubmission: boolean;\n  resubmission_count: number;\n  max_resubmissions: number;\n  status: string;\n}\n\ninterface TrendData {\n  date: string;\n  modification_requests: number;\n}\n\nconst EnhancedModificationDashboard: React.FC = () => {\n  const [stats, setStats] = useState<ModificationStats | null>(null);\n  const [requests, setRequests] = useState<ModificationRequest[]>([]);\n  const [trends, setTrends] = useState<TrendData[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [selectedRequests, setSelectedRequests] = useState<Set<number>>(new Set());\n  const [bulkReminderDays, setBulkReminderDays] = useState(7);\n  const [reminderLoading, setReminderLoading] = useState(false);\n  const [reminderResult, setReminderResult] = useState<string | null>(null);\n\n  useEffect(() => {\n    loadDashboardData();\n  }, []);\n\n  const loadDashboardData = async () => {\n    try {\n      setLoading(true);\n      const token = localStorage.getItem('token');\n      \n      if (!token) {\n        setError('No authentication token found');\n        return;\n      }\n\n      const headers = {\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      };\n\n      // Load stats, requests, and trends in parallel\n      const [statsResponse, requestsResponse, trendsResponse] = await Promise.all([\n        fetch(`${process.env.NEXT_PUBLIC_API_URL}/modification/instructor/modification-stats`, { headers }),\n        fetch(`${process.env.NEXT_PUBLIC_API_URL}/modification/instructor/modification-requests`, { headers }),\n        fetch(`${process.env.NEXT_PUBLIC_API_URL}/modification/instructor/modification-trends?days=30`, { headers })\n      ]);\n\n      if (statsResponse.ok) {\n        const statsData = await statsResponse.json();\n        setStats(statsData.data);\n      }\n\n      if (requestsResponse.ok) {\n        const requestsData = await requestsResponse.json();\n        setRequests(requestsData.data.modification_requests || []);\n      }\n\n      if (trendsResponse.ok) {\n        const trendsData = await trendsResponse.json();\n        setTrends(trendsData.data.trends || []);\n      }\n\n    } catch (err) {\n      console.error('Error loading dashboard data:', err);\n      setError('Failed to load dashboard data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const sendBulkReminders = async () => {\n    try {\n      setReminderLoading(true);\n      setReminderResult(null);\n      \n      const token = localStorage.getItem('token');\n      const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/modification/instructor/send-reminders`, {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          days_overdue: bulkReminderDays\n        })\n      });\n\n      if (response.ok) {\n        const result = await response.json();\n        setReminderResult(`Successfully sent ${result.data.reminders_sent} reminders`);\n        loadDashboardData(); // Refresh data\n      } else {\n        const error = await response.json();\n        setReminderResult(`Failed to send reminders: ${error.error}`);\n      }\n    } catch (err) {\n      console.error('Error sending reminders:', err);\n      setReminderResult('Failed to send reminders');\n    } finally {\n      setReminderLoading(false);\n    }\n  };\n\n  const toggleRequestSelection = (requestId: number) => {\n    const newSelected = new Set(selectedRequests);\n    if (newSelected.has(requestId)) {\n      newSelected.delete(requestId);\n    } else {\n      newSelected.add(requestId);\n    }\n    setSelectedRequests(newSelected);\n  };\n\n  const selectAllPendingRequests = () => {\n    const pendingIds = requests\n      .filter(req => req.needs_resubmission)\n      .map(req => req.id);\n    setSelectedRequests(new Set(pendingIds));\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center p-8\">\n        <RefreshCw className=\"h-8 w-8 animate-spin text-blue-600\" />\n        <span className=\"ml-2\">Loading modification dashboard...</span>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <Alert className=\"border-red-200 bg-red-50\">\n        <AlertTriangle className=\"h-4 w-4\" />\n        <AlertDescription>{error}</AlertDescription>\n      </Alert>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold\">Modification Request Dashboard</h1>\n        <Button onClick={loadDashboardData} variant=\"outline\" size=\"sm\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Refresh\n        </Button>\n      </div>\n\n      {/* Stats Overview */}\n      {stats && (\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-2\">\n                <FileText className=\"h-8 w-8 text-blue-600\" />\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Total Assignments</p>\n                  <p className=\"text-2xl font-bold\">{stats.total_assignments}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-2\">\n                <AlertTriangle className=\"h-8 w-8 text-yellow-600\" />\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Pending Resubmissions</p>\n                  <p className=\"text-2xl font-bold\">{stats.pending_resubmissions}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-2\">\n                <CheckCircle className=\"h-8 w-8 text-green-600\" />\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Completed Resubmissions</p>\n                  <p className=\"text-2xl font-bold\">{stats.completed_resubmissions}</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardContent className=\"p-4\">\n              <div className=\"flex items-center space-x-2\">\n                <TrendingUp className=\"h-8 w-8 text-purple-600\" />\n                <div>\n                  <p className=\"text-sm font-medium text-gray-600\">Modification Rate</p>\n                  <p className=\"text-2xl font-bold\">{stats.modification_rate}%</p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <Tabs defaultValue=\"requests\" className=\"w-full\">\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"requests\">Modification Requests</TabsTrigger>\n          <TabsTrigger value=\"trends\">Trends</TabsTrigger>\n          <TabsTrigger value=\"reminders\">Bulk Actions</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"requests\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <span>Modification Requests</span>\n                <div className=\"flex items-center space-x-2\">\n                  <Badge variant=\"secondary\">\n                    {requests.filter(req => req.needs_resubmission).length} pending\n                  </Badge>\n                  <Button onClick={selectAllPendingRequests} variant=\"outline\" size=\"sm\">\n                    Select All Pending\n                  </Button>\n                </div>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                {requests.length === 0 ? (\n                  <div className=\"text-center py-8 text-gray-500\">\n                    No modification requests found\n                  </div>\n                ) : (\n                  requests.map((request) => (\n                    <div\n                      key={request.id}\n                      className={`border rounded-lg p-4 transition-colors ${\n                        selectedRequests.has(request.id)\n                          ? 'border-blue-500 bg-blue-50'\n                          : 'border-gray-200 hover:border-gray-300'\n                      }`}\n                    >\n                      <div className=\"flex items-start justify-between\">\n                        <div className=\"flex items-start space-x-3\">\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedRequests.has(request.id)}\n                            onChange={() => toggleRequestSelection(request.id)}\n                            className=\"mt-1\"\n                          />\n                          <div className=\"flex-1\">\n                            <h3 className=\"font-semibold\">{request.title}</h3>\n                            <p className=\"text-sm text-gray-600\">\n                              {request.course_title} â€¢ {request.lesson_title}\n                            </p>\n                            <p className=\"text-sm font-medium text-gray-800 mt-1\">\n                              Student: {request.student_name}\n                            </p>\n                            <div className=\"mt-2 p-2 bg-gray-50 rounded text-sm\">\n                              <strong>Reason:</strong> {request.modification_reason}\n                            </div>\n                            <div className=\"flex items-center space-x-4 mt-2 text-sm text-gray-600\">\n                              <span>Requested: {new Date(request.requested_at).toLocaleDateString()}</span>\n                              <span>Resubmissions: {request.resubmission_count}/{request.max_resubmissions}</span>\n                            </div>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <Badge\n                            variant={request.needs_resubmission ? 'destructive' : 'secondary'}\n                          >\n                            {request.needs_resubmission ? 'Pending' : 'Resubmitted'}\n                          </Badge>\n                        </div>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"trends\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center\">\n                <BarChart3 className=\"h-5 w-5 mr-2\" />\n                Modification Request Trends (Last 30 Days)\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {trends.length === 0 ? (\n                <div className=\"text-center py-8 text-gray-500\">\n                  No trend data available\n                </div>\n              ) : (\n                <div className=\"space-y-2\">\n                  {trends.map((trend, index) => (\n                    <div key={index} className=\"flex items-center justify-between py-2 border-b\">\n                      <span className=\"text-sm font-medium\">\n                        {new Date(trend.date).toLocaleDateString()}\n                      </span>\n                      <div className=\"flex items-center space-x-2\">\n                        <div className=\"bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm\">\n                          {trend.modification_requests} requests\n                        </div>\n                        <div \n                          className=\"bg-blue-500 h-2 rounded\"\n                          style={{ \n                            width: `${Math.max(10, (trend.modification_requests / Math.max(...trends.map(t => t.modification_requests))) * 100)}px` \n                          }}\n                        />\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"reminders\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center\">\n                <Send className=\"h-5 w-5 mr-2\" />\n                Bulk Actions & Reminders\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"border rounded-lg p-4\">\n                <h3 className=\"font-semibold mb-3\">Send Bulk Reminders</h3>\n                <p className=\"text-sm text-gray-600 mb-4\">\n                  Send reminder emails to students with overdue resubmissions.\n                </p>\n                <div className=\"flex items-center space-x-3\">\n                  <label className=\"text-sm font-medium\">Days overdue:</label>\n                  <Input\n                    type=\"number\"\n                    value={bulkReminderDays}\n                    onChange={(e) => setBulkReminderDays(parseInt(e.target.value) || 7)}\n                    min=\"1\"\n                    max=\"30\"\n                    className=\"w-20\"\n                  />\n                  <Button\n                    onClick={sendBulkReminders}\n                    disabled={reminderLoading}\n                    className=\"flex items-center space-x-2\"\n                  >\n                    {reminderLoading ? (\n                      <RefreshCw className=\"h-4 w-4 animate-spin\" />\n                    ) : (\n                      <Send className=\"h-4 w-4\" />\n                    )}\n                    <span>Send Reminders</span>\n                  </Button>\n                </div>\n                \n                {reminderResult && (\n                  <Alert className=\"mt-3\">\n                    <AlertDescription>{reminderResult}</AlertDescription>\n                  </Alert>\n                )}\n              </div>\n\n              {selectedRequests.size > 0 && (\n                <div className=\"border rounded-lg p-4\">\n                  <h3 className=\"font-semibold mb-3\">\n                    Selected Requests ({selectedRequests.size})\n                  </h3>\n                  <p className=\"text-sm text-gray-600 mb-4\">\n                    Perform bulk actions on selected modification requests.\n                  </p>\n                  <div className=\"flex items-center space-x-3\">\n                    <Button variant=\"outline\" size=\"sm\">\n                      Send Individual Reminders\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\">\n                      Export Selected\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => setSelectedRequests(new Set())}\n                    >\n                      Clear Selection\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\nexport default EnhancedModificationDashboard;"