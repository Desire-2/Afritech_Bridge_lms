// File Management Component for Assignment Files
import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport {\n  File,\n  Download,\n  Eye,\n  Trash2,\n  Upload,\n  Loader2,\n  AlertCircle,\n  CheckCircle2,\n  Image,\n  Video,\n  Music,\n  Archive,\n  Share,\n  Copy\n} from 'lucide-react';\nimport FileUploadService, { UploadedFile } from '@/services/file-upload.service';\nimport { toast } from 'sonner';\n\ninterface FileManagerProps {\n  assignmentId?: number;\n  projectId?: number;\n  submissionId?: number;\n  isInstructor?: boolean;\n  onFileUpdate?: () => void;\n}\n\ninterface FileWithMetadata extends UploadedFile {\n  id?: string;\n  originalName: string;\n  uploadedBy?: string;\n  canDelete?: boolean;\n  canDownload?: boolean;\n  canPreview?: boolean;\n}\n\nexport const FileManager: React.FC<FileManagerProps> = ({\n  assignmentId,\n  projectId,\n  submissionId,\n  isInstructor = false,\n  onFileUpdate\n}) => {\n  const [files, setFiles] = useState<FileWithMetadata[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [selectedFiles, setSelectedFiles] = useState<Set<string>>(new Set());\n  const [actionLoading, setActionLoading] = useState(false);\n\n  useEffect(() => {\n    loadFiles();\n  }, [assignmentId, projectId, submissionId]);\n\n  const loadFiles = async () => {\n    if (!assignmentId && !projectId) return;\n    \n    setLoading(true);\n    setError(null);\n    \n    try {\n      const endpoint = assignmentId \n        ? `/api/v1/uploads/assignments/${assignmentId}/files`\n        : `/api/v1/uploads/projects/${projectId}/files`;\n      \n      const params = new URLSearchParams();\n      if (submissionId) {\n        params.append('submission_id', submissionId.toString());\n      }\n      \n      const response = await fetch(`${endpoint}?${params}`, {\n        headers: {\n          'Authorization': `Bearer ${localStorage.getItem('token')}`\n        }\n      });\n      \n      const result = await response.json();\n      \n      if (!response.ok) {\n        throw new Error(result.error || 'Failed to load files');\n      }\n      \n      // Transform the files data\n      const transformedFiles: FileWithMetadata[] = result.files.map((file: any, index: number) => ({\n        id: file.id || `file-${index}`,\n        url: file.url,\n        originalName: file.filename || file.originalName || 'Unknown file',\n        size: file.size || 0,\n        contentType: file.contentType || FileUploadService.getContentType(file.filename || ''),\n        uploadedAt: file.uploadedAt || new Date().toISOString(),\n        pathname: file.url,\n        contentDisposition: `attachment; filename=\"${file.filename || 'file'}\"`,\n        uploadedBy: file.uploadedBy,\n        canDelete: isInstructor || !submissionId, // Students can delete only before submission\n        canDownload: true,\n        canPreview: FileUploadService.canPreviewFile(file.filename || '')\n      }));\n      \n      setFiles(transformedFiles);\n    } catch (error: any) {\n      console.error('Error loading files:', error);\n      setError(error.message);\n      toast.error('Failed to load files');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const getFileIcon = (filename: string) => {\n    const ext = FileUploadService.getFileExtension(filename).toLowerCase();\n    \n    if (FileUploadService.isImageFile(filename)) {\n      return <Image className=\"h-5 w-5\" />;\n    } else if (['mp4', 'webm', 'mov', 'avi'].includes(ext)) {\n      return <Video className=\"h-5 w-5\" />;\n    } else if (['mp3', 'wav', 'ogg'].includes(ext)) {\n      return <Music className=\"h-5 w-5\" />;\n    } else if (['zip', 'tar', 'gz', 'rar'].includes(ext)) {\n      return <Archive className=\"h-5 w-5\" />;\n    } else {\n      return <File className=\"h-5 w-5\" />;\n    }\n  };\n\n  const handleDownload = async (file: FileWithMetadata) => {\n    if (!file.canDownload) {\n      toast.error('Download not allowed for this file');\n      return;\n    }\n    \n    try {\n      const link = document.createElement('a');\n      link.href = FileUploadService.getDownloadUrl(file.url, file.originalName);\n      link.download = file.originalName;\n      link.target = '_blank';\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      toast.success(`Downloading ${file.originalName}`);\n    } catch (error: any) {\n      console.error('Download error:', error);\n      toast.error('Failed to download file');\n    }\n  };\n\n  const handlePreview = (file: FileWithMetadata) => {\n    if (!file.canPreview) {\n      toast.error('Preview not available for this file type');\n      return;\n    }\n    \n    window.open(file.url, '_blank');\n  };\n\n  const handleDelete = async (file: FileWithMetadata) => {\n    if (!file.canDelete) {\n      toast.error('Delete not allowed for this file');\n      return;\n    }\n    \n    if (!confirm(`Are you sure you want to delete ${file.originalName}?`)) {\n      return;\n    }\n    \n    setActionLoading(true);\n    \n    try {\n      await FileUploadService.deleteFile(file.url);\n      setFiles(prev => prev.filter(f => f.id !== file.id));\n      toast.success('File deleted successfully');\n      \n      if (onFileUpdate) {\n        onFileUpdate();\n      }\n    } catch (error: any) {\n      console.error('Delete error:', error);\n      toast.error('Failed to delete file');\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const handleCopyLink = async (file: FileWithMetadata) => {\n    try {\n      await navigator.clipboard.writeText(file.url);\n      toast.success('Link copied to clipboard');\n    } catch (error: any) {\n      console.error('Copy error:', error);\n      toast.error('Failed to copy link');\n    }\n  };\n\n  const handleShare = async (file: FileWithMetadata) => {\n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: file.originalName,\n          url: file.url\n        });\n      } catch (error: any) {\n        if (error.name !== 'AbortError') {\n          console.error('Share error:', error);\n          handleCopyLink(file);\n        }\n      }\n    } else {\n      handleCopyLink(file);\n    }\n  };\n\n  const toggleFileSelection = (fileId: string) => {\n    setSelectedFiles(prev => {\n      const newSet = new Set(prev);\n      if (newSet.has(fileId)) {\n        newSet.delete(fileId);\n      } else {\n        newSet.add(fileId);\n      }\n      return newSet;\n    });\n  };\n\n  const handleBulkAction = async (action: 'download' | 'delete') => {\n    if (selectedFiles.size === 0) {\n      toast.error('No files selected');\n      return;\n    }\n    \n    const selectedFilesList = files.filter(f => selectedFiles.has(f.id!));\n    \n    if (action === 'download') {\n      setActionLoading(true);\n      try {\n        for (const file of selectedFilesList) {\n          if (file.canDownload) {\n            await handleDownload(file);\n            await new Promise(resolve => setTimeout(resolve, 100)); // Small delay between downloads\n          }\n        }\n        toast.success(`Downloaded ${selectedFilesList.length} files`);\n      } finally {\n        setActionLoading(false);\n      }\n    } else if (action === 'delete') {\n      const deletableFiles = selectedFilesList.filter(f => f.canDelete);\n      \n      if (deletableFiles.length === 0) {\n        toast.error('No files can be deleted');\n        return;\n      }\n      \n      if (!confirm(`Are you sure you want to delete ${deletableFiles.length} files?`)) {\n        return;\n      }\n      \n      setActionLoading(true);\n      try {\n        for (const file of deletableFiles) {\n          await FileUploadService.deleteFile(file.url);\n        }\n        \n        setFiles(prev => prev.filter(f => !deletableFiles.some(df => df.id === f.id)));\n        setSelectedFiles(new Set());\n        toast.success(`Deleted ${deletableFiles.length} files`);\n        \n        if (onFileUpdate) {\n          onFileUpdate();\n        }\n      } catch (error: any) {\n        console.error('Bulk delete error:', error);\n        toast.error('Failed to delete some files');\n      } finally {\n        setActionLoading(false);\n      }\n    }\n  };\n\n  if (loading) {\n    return (\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-center justify-center\">\n            <Loader2 className=\"h-6 w-6 animate-spin mr-2\" />\n            <span>Loading files...</span>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (error) {\n    return (\n      <Card>\n        <CardContent className=\"p-6\">\n          <Alert variant=\"destructive\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription>{error}</AlertDescription>\n          </Alert>\n          <Button onClick={loadFiles} className=\"mt-4\" variant=\"outline\">\n            Retry\n          </Button>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (files.length === 0) {\n    return (\n      <Card>\n        <CardContent className=\"p-6\">\n          <div className=\"text-center text-gray-500 dark:text-gray-400\">\n            <File className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n            <p>No files uploaded yet</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"flex items-center\">\n            <File className=\"h-5 w-5 mr-2\" />\n            Files ({files.length})\n          </CardTitle>\n          \n          {selectedFiles.size > 0 && (\n            <div className=\"flex items-center gap-2\">\n              <Badge variant=\"outline\">{selectedFiles.size} selected</Badge>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => handleBulkAction('download')}\n                disabled={actionLoading}\n              >\n                <Download className=\"h-4 w-4 mr-1\" />\n                Download\n              </Button>\n              {(isInstructor || !submissionId) && (\n                <Button\n                  size=\"sm\"\n                  variant=\"destructive\"\n                  onClick={() => handleBulkAction('delete')}\n                  disabled={actionLoading}\n                >\n                  <Trash2 className=\"h-4 w-4 mr-1\" />\n                  Delete\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n      </CardHeader>\n      \n      <CardContent>\n        <div className=\"space-y-3\">\n          {files.map((file) => (\n            <div \n              key={file.id} \n              className={`flex items-center justify-between p-3 rounded-lg border transition-colors ${\n                selectedFiles.has(file.id!) \n                  ? 'border-blue-500 bg-blue-50 dark:bg-blue-950/20' \n                  : 'border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600'\n              }`}\n            >\n              <div className=\"flex items-center space-x-3 flex-1 min-w-0\">\n                <input\n                  type=\"checkbox\"\n                  checked={selectedFiles.has(file.id!)}\n                  onChange={() => toggleFileSelection(file.id!)}\n                  className=\"rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                />\n                \n                <div className=\"flex-shrink-0 text-blue-600 dark:text-blue-400\">\n                  {getFileIcon(file.originalName)}\n                </div>\n                \n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium text-gray-900 dark:text-white truncate\">\n                    {file.originalName}\n                  </p>\n                  <div className=\"flex items-center gap-4 mt-1\">\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n                      {FileUploadService.formatBytes(file.size)}\n                    </p>\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n                      {new Date(file.uploadedAt).toLocaleDateString()}\n                    </p>\n                    {file.uploadedBy && (\n                      <p className=\"text-xs text-gray-500 dark:text-gray-400\">\n                        by {file.uploadedBy}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              </div>\n              \n              <div className=\"flex items-center space-x-2\">\n                {file.canPreview && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handlePreview(file)}\n                    className=\"h-8 w-8 p-0\"\n                    title=\"Preview\"\n                  >\n                    <Eye className=\"h-4 w-4\" />\n                  </Button>\n                )}\n                \n                {file.canDownload && (\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleDownload(file)}\n                    className=\"h-8 w-8 p-0\"\n                    title=\"Download\"\n                  >\n                    <Download className=\"h-4 w-4\" />\n                  </Button>\n                )}\n                \n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => handleShare(file)}\n                  className=\"h-8 w-8 p-0\"\n                  title=\"Share\"\n                >\n                  <Share className=\"h-4 w-4\" />\n                </Button>\n                \n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => handleCopyLink(file)}\n                  className=\"h-8 w-8 p-0\"\n                  title=\"Copy Link\"\n                >\n                  <Copy className=\"h-4 w-4\" />\n                </Button>\n                \n                {file.canDelete && (\n                  <Button\n                    variant=\"destructive\"\n                    size=\"sm\"\n                    onClick={() => handleDelete(file)}\n                    className=\"h-8 w-8 p-0\"\n                    title=\"Delete\"\n                    disabled={actionLoading}\n                  >\n                    {actionLoading ? (\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                    ) : (\n                      <Trash2 className=\"h-4 w-4\" />\n                    )}\n                  </Button>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n        \n        {/* Summary */}\n        <div className=\"mt-4 pt-4 border-t border-gray-200 dark:border-gray-700\">\n          <div className=\"flex items-center justify-between text-sm text-gray-500 dark:text-gray-400\">\n            <span>\n              Total: {files.length} files ({FileUploadService.formatBytes(files.reduce((sum, file) => sum + file.size, 0))})\n            </span>\n            <span>\n              {files.filter(f => f.canDelete).length > 0 && `${files.filter(f => f.canDelete).length} can be deleted`}\n            </span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default FileManager;